# PRD - Stefan Updated

[Results - Convoy and Explorer Discovery & Priotization.pdf](Results_-_Convoy_and_Explorer_Discovery__Priotization.pdf)

This is **Peak Flow: Definitive System Specification (v13.0)**.

This version strictly preserves the technical density of your previous PRD (v11.0)—including the specific logic for "Nearby Me" radius expansion, "Spider-Leg" clustering, and the "Chassis Threat" lists—while applying the two requested research-centric changes:

1. **Map-Centric Discovery:** The Home Screen is now the Interactive Map with overlaid Search and Creation CTAs.
2. **Consolidated Library:** "Performance" is now a sub-feature within Tab 3.

---

# Peak Flow: Definitive System Specification (v13.0)

## Platform  Strategy & Architecture

To ensure a seamless "Fluid-Sync" experience, the system is split into two distinct execution environments:

- **Platform A: Mobile App (iOS + CarPlay):** The "Planning & Social" layer. Handles cloud-heavy tasks, AI generation, and standard navigation via CarPlay.
- **Platform B: Native OEM (Vehicle Head-Unit):** The "Tactical & Telemetry" layer. Handles deep vehicle integration (CAN-bus), Spatial Audio processing, and high-performance navigation (**TomTom Orbis Native SDK**).

---

## 1. Information Architecture & Navigation

The mobile interface is designed for high-end aesthetic appeal, using a Glassmorphism and a "dark-mode" first approach to reduce cognitive load during the transition from device to vehicle.

- **Tab 1: Discover** – The map-centric entry point for finding the next "Escape."
- **Tab 2: Squad** – Social lobby and Radar discovery (Transitions to Convoy Mode).
- **Tab 3: Library** – Personal archive containing **Trips** (History & Performance), **Favorites**, and **Wishlist**.
- **Tab 4: Profile** – Vehicle settings and "Verified Pilot" status.

---

## 2. Epic 1: Explorer (Discovery & Social)

### 2.1 Discovery Start Page Structure (Map-Centric)

The Discover tab has been reorganized to prioritize spatial context. The **Interactive Map** is now the primary background canvas, with Search and Inspiration acting as functional overlays.

### **A. The Canvas: Interactive Map Portal**

- **Interaction:** The map occupies the full screen  immediately upon load.
- **Visuals:** Renders "Apex Orange" route ribbons in the user's vicinity.
- **Map Gestures:**
    - **Line-Tap:** Tapping a route ribbon directly on the map triggers the **Route Summary Bottom Sheet**.
    - **Clustering:** If routes are geographically overlapping, a single tap triggers a **"Spider-Leg" expansion** or zoom-in; a second tap selects the specific line.

### **B. Top Overlay: Search & Creation**

*Floating at the top of the Map Canvas.*

1. **Omni-Search Bar:**
    - **Search Logic:** Queries the curated route library by name, region, or POI.
    - **Real-time Suggestions:** Displays a maximum of 3 "Recent" searches and 5 "Predicted Locations/Routes" as the user types.
    - **The "Empty State" Pivot:** If no search results match, the system displays a high-prominence CTA: *“No routes found. Create your own route.”*
2. **Creation CTA:** A single, prominent button positioned immediately below the Search Bar:
    - **"Create own route":** Launches the **Route Builder Panel** (Bottom Overlay).
    - **Panel Interaction:**
        - **Start:** Defaults to "Current GPS Location" (Editable).
        - **Destination:** Placeholder "Add destination".
        - **Action:** Orange CTA **"Automatic Route Generator"** launches the AI Architect.

### **C. Bottom Overlay: Categorized Inspiration (Scrollable Stacks)**

*Hidden by default. Accessible via "List View" toggle.*

*Horizontal scrollable containers located at the bottom of the screen, overlaying the map.*

1. **"Nearby Me":**
    - **Logic:** Initially queries routes within a **25km radius**.
    - **Expansion Logic:** If result count < 3, automatically expand radius in increments up to **300km**.
    - **Fallthrough:** If no routes exist within 300km, replace the stack with a wide-format CTA card: *“Nothing nearby. Be a pioneer and create a route.”*
2. **"Themes":**
    - **Relaxed:** (High SSS, Scenic, or Deep Flow — Technical, High Curviness Index).
    - **Challenging:** (Technical, High Curviness Index, demanding roads).
3. **"Time-Based":**
    - The Quick Escape: (30m).
    - The Sprint: (1h).
    - The Odyssey: (4h+).
- **UX Interaction:** Category Title Click opens a Vertical List View. Route Card Click opens the Route Summary Bottom Sheet.

### 2.2 List View: Sorting & Filtering Logic

*Applicable to Search Results and Expanded Categories.*

### **2.2.1 Sorting ("Soft" Boundary)**

- **Default (Search):** "Relevance" (weighted by proximity to current GPS and keyword match).
- **Default (Category):** "Distance" (Absolute distance to the start point).

### **2.2.2 Filtering ("Hard" Boundary)**

Filters strictly exclude routes that do not meet chosen criteria.

- **Quick-Access Pills:** Horizontal scroll of buttons (e.g., "SSS > 9", "Curvy", "< 1 Hour").
- **The "Flow Filter" Sheet:** A bottom-drawer UI for complex combinations.
    - **SSS Threshold:** Slider ranging from 1.0 to 10.0 (e.g., "Only show SSS 8+").
    - **Atmosphere:** Multi-select chips (Alpine, Coastal, Forest, Industrial).

### 2.3 The Route Evaluation Hierarchy (Overview & Details)

To maintain a low cognitive load, the system uses a progressive disclosure model. Selection of a route triggers the **"Handshake" Animation**: the background map executes a "Fly-to" to center the route polyline while the evaluation UI slides up.

### **2.3.1 Layer 1: The Route Overview (The "Hook")**

**UI Component:** Bottom Sheet (40% Screen Height).

- **Visual Header:** A high-resolution hero image (Logic: Waypoint → Destination → Generic Atmosphere).
- **Primary Identity:**
    - **Title:** Bold, high-contrast typography (e.g., *"The Black Forest Hairpins"*).
    - **Author:** Verified Pilot name or "Peak Flow Curated."
- **The "Vitals" Bar:** Four key icons with real-time values:
    - **Distance:** Total length in $km$.
    - **Estimated Time:** Based on a spirited driving profile (not standard traffic).
    - **SSS Badge:** The 1–10 score in its color-coded ring (e.g., **9.4 - Apex**).
    - **Curviness Index (CI):** A 1–5 "Zig-Zag" rating representing technicality.
- **Social Engagement:** Total "Heart" (Like) count.

### **2.3.2 Layer 2: The Route Details (The "Deep Dive")**

**UI Component:** Full-Screen Modal. Accessed by swiping up on the Overview Sheet.

- **Surface Composition:** Percentage breakdown (e.g., **98% Asphalt / 2% Paved**). *Note: Any "Unpaved" % triggers a red alert.*
- **Elevation & Gradient Profile:**
    - **2D Graph:** A linear plot showing altitude changes ($m$) over total distance.
    - **Max/Min Gradient:** Highlighting the steepest sections (e.g., **Max Grade: 11%**).
- **The "Chassis Threat" List:** An itemized list of specific SSS deductions:
    - *"3 Speed Humps detected"*
    - *"1 Pothole reported (24m ago)"*
- **Gallery & Waypoints:** Community photos and vertical timeline of planned stops (Scenic overlooks, High-octane fuel).

### **2.3.3 Standardized Action Bar (CTAs)**

Sticky at the bottom of both Overview and Detail views.

- **Start Drive (Primary):** Launches TomTom SDK Nav + triggers "Send to McLaren" prompt.
- **Form Convoy (Secondary):** Transitions to Squad Tab; pre-populates the builder with this route.
- **Share (Icon):** Opens iOS Share Sheet with a Peak Flow Universal Link.
- **Heart (Icon):** Toggles "Favorite" status.

### 2.4 Automatic Route Generation (The "AI Architect")

*Triggered via the Top Overlay CTA or Search Empty State.*

**Mode A: Voice-to-Flow**

- **Input:** User records voice intent (e.g., *"Find me a curvy 2-hour loop heading North with no speed humps"*).
- **Orchestration:** **Claude/Gemini** processes intent $\rightarrow$ JSON Object (Start, Waypoints, Destination).
- **Validation:** **TomTom SDK** snaps to road $\rightarrow$ Automatic **SSS Audit** (checks for hazards).

**Mode B: Parameter Selection**

- **Duration:** Slider from **<1h** up to **Multiple Days**.
- **Direction:** Selectors for **North, South, East, West**.
- **Characteristics:** Toggle **Challenging** (Technical/Curve-focused) vs. **Relaxing** (Scenic/SSS-focused).

### 2.5 Manual Route Planning (The "Draftsman")

*Triggered via the Top Overlay CTA.*

- **Waypoint Management:** Search-to-Add major stops or **Long-Press-on-Map** to drop pins.
- **Rubber-Banding:** Interactively drag route polyline to "snap" to specific roads.
- **System Logic:** Native Snap-to-Road ensures driveability; Hard toggle to "Minimize Speed Humps".

---

## 3. Epic 2: Squad (Convoy & Social Coordination)

*The Squad tab is the mission control for group driving. It transitions from a Planning Hub to a Tactical Execution Engine.*

### 3.1 Squad Start Page Structure

- **Primary Action:** **Create Convoy** (Instant/Scheduled) and **Join Convoy** (Enter 6-Digit Code / Scan QR).
- **Secondary Action:** "Radar" (nearby public convoys) is relegated to a small icon/secondary tab.
- **Builder Flow:** Add Users (Search) $\rightarrow$ Add Title $\rightarrow$ Add Route $\rightarrow$ "Drive Now" or "Schedule Event".

### 3.2 Convoy Mode Execution

- **Digital Tether:** Leader dictates route; Followers use `reconstructionMode: .track` via TomTom SDK for 100% parity.
- **Spatial Audio:** PTT voices panned via Azimuth calculation: $\theta = \operatorname{atan2}(\Delta \text{Lon}, \Delta \text{Lat}) - \text{Heading}$.
- **Fragmentation State Machine:**
    - **Connected ($<1km$):** "Pack Green."
    - **Fragmented ($1km - 2.5km$):** "Orange Alert: Gap detected."
    - **Disconnected ($>2.5km$):** "Critical: Follower Lost."

---

## 4. Epic 3: Library (Trips & Performance)

*Consolidated Tab 3 containing History, Performance, Favorites, and Wishlist.*

### 4.1 Trip History (The Memory)

- **Auto-Record:** Logs all trips $>2km$.
- **Recap View:** Displays photos, notes, and route summary (The "Scrapbook").

### 4.2 Performance Layer (Sub-Feature)

*Located as a secondary toggle within a specific Trip entry.*

- **Telemetry:** GPS trajectory, gear selection, fuel consumption, speed peaks.
- **Heatmaps:** Map overlays showing Speed Intensity and G-Force rankings.
- **Benchmarking:** Segment-based rankings (e.g., "Sector 3 Time").

### 4.3 Social Logic

- **Favorites:** Hearted routes synced for offline planning.
- **Wishlist:** Routes saved for future consideration.

---

## 5. Technical Specifications

### 5.1 Supercar Suitability Score (SSS)

- **Formula:** $SSS = 10 - (D_{unpaved} + D_{hump} + D_{pothole})$.
- **HMI Alerts:** Visual icon displayed **200m** prior to deflection; flash interrupt for real-time pothole reports.

### 5.2 Offline Capability

- **20GB FIFO Cache:** Prioritizes map tiles, SSS gradient data, and convoy telemetry for areas without cellular signal.

### 5.3 Forced Geometry Logic

- **Mechanism:** App pushes a dense array of coordinates (every 100m) to the TomTom SDK.
- **Real-time Editing:** If the Leader modifies the route, the new polyline is pushed via MQTT, forcing an instant sync.